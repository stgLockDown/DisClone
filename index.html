<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nexus Chat</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="streaming.css">
    <link rel="stylesheet" href="calls.css">
  <link rel="stylesheet" href="twitch.css">
  <link rel="stylesheet" href="server-admin.css">
  <link rel="stylesheet" href="social.css">
  <link rel="stylesheet" href="themes.css">
  <link rel="stylesheet" href="auth.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<script src="https://sites.super.myninja.ai/_assets/ninja-daytona-script.js"></script>
</head>
<body>

<!-- ============ AUTH SCREEN ============ -->
<div class="auth-overlay" id="authOverlay">
  <div class="auth-bg"></div>
  <div class="auth-card">
    <div class="auth-logo">
      <div class="auth-logo-icon">N</div>
    </div>
    <h1 class="auth-title" id="authTitle">Create an Account</h1>
    <p class="auth-subtitle" id="authSubtitle">Join Nexus Chat and start connecting with your community</p>

    <!-- Tab Switcher -->
    <div class="auth-tabs">
      <button class="auth-tab active" id="tabSignup" onclick="switchAuthTab('signup')">Sign Up</button>
      <button class="auth-tab" id="tabLogin" onclick="switchAuthTab('login')">Log In</button>
    </div>

    <!-- Global Error -->
    <div class="auth-global-error" id="authGlobalError"></div>

    <!-- SIGNUP FORM -->
    <form class="auth-form active" id="signupForm" onsubmit="handleAuthSubmit(event, 'signup')">
      <div class="auth-field">
        <label class="auth-label">Email <span class="required">*</span></label>
        <input class="auth-input" type="email" id="signupEmail" placeholder="you@example.com" required autocomplete="email">
        <div class="auth-error" id="signupEmailError"></div>
      </div>
      <div class="auth-field">
        <label class="auth-label">Display Name <span class="required">*</span></label>
        <input class="auth-input" type="text" id="signupDisplayName" placeholder="How others will see you" required autocomplete="name" maxlength="32">
        <div class="auth-error" id="signupDisplayNameError"></div>
      </div>
      <div class="auth-field">
        <label class="auth-label">Username <span class="required">*</span></label>
        <input class="auth-input" type="text" id="signupUsername" placeholder="unique_username" required autocomplete="username" maxlength="20" pattern="[a-zA-Z0-9_]{3,20}">
        <div class="auth-error" id="signupUsernameError"></div>
      </div>
      <div class="auth-field">
        <label class="auth-label">Password <span class="required">*</span></label>
        <input class="auth-input" type="password" id="signupPassword" placeholder="At least 6 characters" required autocomplete="new-password" minlength="6" oninput="updatePasswordStrength(this.value)">
        <div class="password-strength" id="passwordStrength">
          <div class="password-strength-bar" id="pwBar1"></div>
          <div class="password-strength-bar" id="pwBar2"></div>
          <div class="password-strength-bar" id="pwBar3"></div>
          <div class="password-strength-bar" id="pwBar4"></div>
        </div>
        <div class="auth-error" id="signupPasswordError"></div>
      </div>
      <label class="auth-remember">
        <input type="checkbox" id="signupRemember" checked>
        <span class="auth-checkbox"></span>
        <span class="auth-remember-text"><strong>Stay signed in</strong> â€” don't ask me to log in again on this device</span>
      </label>
      <button class="auth-submit" type="submit" id="signupBtn">
        <span class="btn-text">Create Account</span>
        <div class="spinner"></div>
      </button>
    </form>

    <!-- LOGIN FORM -->
    <form class="auth-form" id="loginForm" onsubmit="handleAuthSubmit(event, 'login')">
      <div class="auth-field">
        <label class="auth-label">Email or Username <span class="required">*</span></label>
        <input class="auth-input" type="text" id="loginEmail" placeholder="you@example.com or username" required autocomplete="email">
        <div class="auth-error" id="loginEmailError"></div>
      </div>
      <div class="auth-field">
        <label class="auth-label">Password <span class="required">*</span></label>
        <input class="auth-input" type="password" id="loginPassword" placeholder="Your password" required autocomplete="current-password">
        <div class="auth-error" id="loginPasswordError"></div>
      </div>
      <label class="auth-remember">
        <input type="checkbox" id="loginRemember" checked>
        <span class="auth-checkbox"></span>
        <span class="auth-remember-text"><strong>Stay signed in</strong> â€” don't ask me to log in again on this device</span>
      </label>
      <button class="auth-submit" type="submit" id="loginBtn">
        <span class="btn-text">Log In</span>
        <div class="spinner"></div>
      </button>
    </form>

    <div class="auth-footer" id="authFooter">
      Already have an account? <a onclick="switchAuthTab('login')">Log in</a>
    </div>
  </div>
</div>

<!-- Tooltip -->
<div class="tooltip" id="tooltip"></div>

<!-- Context Menu -->
<div class="context-menu" id="contextMenu">
  <div class="context-menu-item" data-action="reply">ğŸ’¬ Reply</div>
  <div class="context-menu-item" data-action="edit">âœï¸ Edit Message</div>
  <div class="context-menu-item" data-action="pin">ğŸ“Œ Pin Message</div>
  <div class="context-menu-item" data-action="react">ğŸ˜€ Add Reaction</div>
  <div class="context-menu-item" data-action="thread">ğŸ§µ Create Thread</div>
  <div class="context-menu-separator"></div>
  <div class="context-menu-item" data-action="copy">ğŸ“‹ Copy Text</div>
  <div class="context-menu-item" data-action="copyid">ğŸ†” Copy Message ID</div>
  <div class="context-menu-separator"></div>
  <div class="context-menu-item danger" data-action="delete">ğŸ—‘ï¸ Delete Message</div>
</div>

<!-- User Profile Popup -->
<div class="user-popup" id="userPopup">
  <div class="user-popup-banner" id="popupBanner"></div>
  <div class="user-popup-avatar-wrap">
    <div class="user-popup-avatar" id="popupAvatar" style="background: var(--nexus-primary);">U</div>
  </div>
  <div class="user-popup-body">
    <div class="user-popup-name" id="popupName">Username</div>
    <div class="user-popup-tag" id="popupTag">username#0001</div>
    <div class="user-popup-section">
      <h4>About Me</h4>
      <p id="popupAbout">Hey there! I'm using Nexus Chat.</p>
    </div>
    <div class="user-popup-section">
      <h4>Roles</h4>
      <div class="user-popup-roles" id="popupRoles">
        <div class="role-tag"><span class="role-dot" style="background:#0ea5e9"></span> Member</div>
      </div>
    </div>
    <input class="user-popup-input" placeholder="Message @username" id="popupMsgInput">
  </div>
</div>

<!-- Lightbox -->
<div class="lightbox" id="lightbox" onclick="this.classList.remove('visible')">
  <img id="lightboxImg" src="" alt="">
</div>

<!-- Settings Overlay -->
<div class="settings-overlay" id="settingsOverlay">
  <div class="settings-nav">
    <div class="settings-nav-inner">
      <div class="settings-nav-category">User Settings</div>
      <div class="settings-nav-item active" data-section="account">My Account</div>
      <div class="settings-nav-item" data-section="profile">Profile</div>
      <div class="settings-nav-item" data-section="privacy">Privacy & Safety</div>
      <div class="settings-nav-item" data-section="devices">Authorized Devices</div>
      <div class="settings-nav-separator"></div>
      <div class="settings-nav-category">App Settings</div>
      <div class="settings-nav-item" data-section="appearance">Appearance</div>
      <div class="settings-nav-item" data-section="accessibility">Accessibility</div>
      <div class="settings-nav-item" data-section="voice">Voice & Video</div>
      <div class="settings-nav-item" data-section="notifications">Notifications</div>
      <div class="settings-nav-item" data-section="keybinds">Keybinds</div>
      <div class="settings-nav-item" data-section="language">Language</div>
      <div class="settings-nav-separator"></div>
      <div class="settings-nav-category">Nexus Pro</div>
      <div class="settings-nav-item" data-section="pro">Nexus Pro</div>
      <div class="settings-nav-item" data-section="boosts">Server Boosts</div>
      <div class="settings-nav-separator"></div>
      <div class="settings-nav-item danger" data-section="logout" style="color:var(--nexus-danger)">Log Out</div>
    </div>
  </div>
  <div class="settings-content" id="settingsContent">
    <div class="settings-section">
      <h2>My Account</h2>
      <div class="settings-card">
        <div style="display:flex;align-items:center;gap:16px;margin-bottom:16px;">
          <div style="width:80px;height:80px;border-radius:50%;background:var(--nexus-primary);display:flex;align-items:center;justify-content:center;font-size:28px;font-weight:800;color:#fff;">N</div>
          <div>
            <div style="font-size:18px;font-weight:700;color:var(--text-primary);">NexusUser</div>
            <div style="font-size:13px;color:var(--text-muted);">nexususer#7842</div>
          </div>
          <button class="btn btn-primary" style="margin-left:auto;">Edit Profile</button>
        </div>
        <div class="settings-row">
          <div>
            <div class="settings-row-label">Username</div>
            <div class="settings-row-desc">NexusUser#7842</div>
          </div>
          <button class="btn btn-secondary">Edit</button>
        </div>
        <div class="settings-row">
          <div>
            <div class="settings-row-label">Email</div>
            <div class="settings-row-desc">n****r@email.com</div>
          </div>
          <button class="btn btn-secondary">Reveal</button>
        </div>
        <div class="settings-row">
          <div>
            <div class="settings-row-label">Phone Number</div>
            <div class="settings-row-desc">Not added</div>
          </div>
          <button class="btn btn-secondary">Add</button>
        </div>
      </div>
      <div class="settings-card">
        <h3 style="font-size:14px;font-weight:700;color:var(--text-primary);margin-bottom:12px;">Password & Authentication</h3>
        <button class="btn btn-primary">Change Password</button>
        <div class="settings-row" style="margin-top:12px;">
          <div>
            <div class="settings-row-label">Two-Factor Authentication</div>
            <div class="settings-row-desc">Protect your account with an extra layer of security</div>
          </div>
          <div class="toggle" onclick="this.classList.toggle('active')"></div>
        </div>
      </div>
    </div>
  </div>
  <div class="settings-close" id="settingsClose">âœ•</div>
</div>

<!-- Create Server Modal -->
<div class="modal-overlay" id="createServerModal">
  <div class="modal">
    <div class="modal-header">
      <h2>Create a Space</h2>
      <p>Your space is where you and your friends hang out. Create yours and start chatting.</p>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Space Name</label>
        <input class="form-input" id="newServerName" placeholder="My Awesome Space" value="">
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <div style="width:64px;height:64px;border-radius:16px;background:var(--bg-tertiary);display:flex;align-items:center;justify-content:center;cursor:pointer;border:2px dashed var(--border-strong);color:var(--text-muted);font-size:24px;" title="Upload icon">ğŸ“·</div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('createServerModal')">Cancel</button>
      <button class="btn btn-primary" onclick="createServer()">Create Space</button>
    </div>
  </div>
</div>

<!-- Invite Modal -->
<div class="modal-overlay" id="inviteModal">
  <div class="modal">
    <div class="modal-header">
      <h2>Invite Friends</h2>
      <p>Share this invite link with others to grant access to your server.</p>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Invite Link</label>
        <div style="display:flex;gap:8px;">
          <input class="form-input" id="inviteLinkInput" readonly style="flex:1;">
          <button class="btn btn-primary" onclick="copyInviteLink()">Copy</button>
        </div>
      </div>
      <div id="inviteStatus" style="font-size:13px;margin-top:8px;"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('inviteModal')">Done</button>
    </div>
  </div>
</div>

<!-- Join Server Modal -->
<div class="modal-overlay" id="joinServerModal">
  <div class="modal">
    <div class="modal-header">
      <h2>Join a Server</h2>
      <p>Enter an invite code or link to join an existing server.</p>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Invite Link or Code</label>
        <input class="form-input" id="joinInviteCode" placeholder="Enter invite code (e.g. AbCdEfGh)">
      </div>
      <div id="joinServerResult" style="font-size:13px;margin-top:8px;"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('joinServerModal')">Cancel</button>
      <button class="btn btn-primary" onclick="joinServerViaInvite()">Join Server</button>
    </div>
  </div>
</div>

<!-- Server Creation Wizard -->
<div class="wizard-overlay" id="serverWizard">
  <div class="wizard">
    <div class="wizard-header">
      <h2 id="wizardTitle">Create Your Space</h2>
      <p id="wizardDesc">Choose a template or start from scratch.</p>
    </div>
    <div class="wizard-body" id="wizardBody">
      <!-- Step 1: Template Selection -->
      <div class="template-grid" id="templateGrid"></div>
    </div>
    <div class="wizard-footer">
      <div class="wizard-step-indicator" id="wizardSteps">
        <div class="wizard-step-dot active"></div>
        <div class="wizard-step-dot"></div>
        <div class="wizard-step-dot"></div>
      </div>
      <div style="display:flex;gap:8px;">
        <button class="btn btn-secondary" id="wizardBackBtn" onclick="wizardBack()" style="display:none;">Back</button>
        <button class="btn btn-secondary" onclick="closeWizard()">Cancel</button>
        <button class="btn btn-primary" id="wizardNextBtn" onclick="wizardNext()">Next</button>
      </div>
    </div>
  </div>
</div>

<!-- Channel Creation Modal -->
<div class="modal-overlay" id="channelCreateModal">
  <div class="modal channel-create-modal">
    <div class="modal-header">
      <h2>Create Channel</h2>
      <p>Add a new channel to your server.</p>
    </div>
    <div class="modal-body">
      <div class="channel-type-grid" id="channelTypeGrid">
        <div class="channel-type-option selected" data-type="text" onclick="selectChannelType(this,'text')">
          <span class="channel-type-icon">#</span>
          <div><div class="channel-type-name">Text</div><div class="channel-type-desc">Send messages</div></div>
        </div>
        <div class="channel-type-option" data-type="voice" onclick="selectChannelType(this,'voice')">
          <span class="channel-type-icon">ğŸ”Š</span>
          <div><div class="channel-type-name">Voice</div><div class="channel-type-desc">Talk & stream</div></div>
        </div>
        <div class="channel-type-option" data-type="announcement" onclick="selectChannelType(this,'announcement')">
          <span class="channel-type-icon">ğŸ“¢</span>
          <div><div class="channel-type-name">Announce</div><div class="channel-type-desc">Broadcast updates</div></div>
        </div>
        <div class="channel-type-option" data-type="stage" onclick="selectChannelType(this,'stage')">
          <span class="channel-type-icon">ğŸ­</span>
          <div><div class="channel-type-name">Stage</div><div class="channel-type-desc">Host events</div></div>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Channel Name</label>
        <input class="form-input" id="newChannelName" placeholder="new-channel">
      </div>
      <div class="form-group">
        <label class="form-label">Topic (optional)</label>
        <input class="form-input" id="newChannelTopic" placeholder="What's this channel about?">
      </div>
      <div class="form-group">
        <label class="form-label">Folder</label>
        <select class="form-input" id="newChannelFolder" style="padding:8px 12px;"></select>
      </div>
      <div class="privacy-toggle-row">
        <div>
          <div class="privacy-toggle-label">ğŸ”’ Private Channel</div>
          <div class="privacy-toggle-desc">Only selected roles and members can view</div>
        </div>
        <div class="toggle" id="channelPrivateToggle" onclick="this.classList.toggle('active')"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('channelCreateModal')">Cancel</button>
      <button class="btn btn-primary" onclick="createNewChannel()">Create Channel</button>
    </div>
  </div>
</div>

<!-- Watch Party Creation Modal -->
<div class="modal-overlay" id="watchPartyModal">
  <div class="modal">
    <div class="modal-header">
      <h2>ğŸ¬ Start Watch Party</h2>
      <p>Watch together with your friends in real-time.</p>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Party Name</label>
        <input class="form-input" id="wpName" placeholder="Movie Night ğŸ¿" value="Watch Party">
      </div>
      <label class="form-label">What are we watching?</label>
      <div class="wp-create-sources">
        <div class="wp-source-option selected" data-source="twitch" onclick="selectWPSource(this,'twitch')">
          <span class="wp-source-icon">ğŸ“º</span>
          <span class="wp-source-name">Twitch Stream</span>
        </div>
        <div class="wp-source-option" data-source="screen" onclick="selectWPSource(this,'screen')">
          <span class="wp-source-icon">ğŸ–¥ï¸</span>
          <span class="wp-source-name">Screen Share</span>
        </div>
        <div class="wp-source-option" data-source="youtube" onclick="selectWPSource(this,'youtube')">
          <span class="wp-source-icon">â–¶ï¸</span>
          <span class="wp-source-name">YouTube</span>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">URL or Stream Name</label>
        <input class="form-input" id="wpSourceUrl" placeholder="Enter URL or streamer name...">
      </div>
      <div class="privacy-toggle-row">
        <div>
          <div class="privacy-toggle-label">ğŸ”’ Private Party</div>
          <div class="privacy-toggle-desc">Only invited members can join</div>
        </div>
        <div class="toggle" id="wpPrivateToggle" onclick="this.classList.toggle('active')"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('watchPartyModal')">Cancel</button>
      <button class="btn btn-primary" onclick="startWatchParty()">ğŸ¬ Start Party</button>
    </div>
  </div>
</div>

<!-- Server Settings Panel -->
<div class="server-settings-overlay" id="serverSettingsOverlay">
  <div class="ss-nav">
    <div class="ss-nav-inner" id="ssNavInner">
      <div class="ss-nav-category" id="ssServerName">Server Settings</div>
      <div class="ss-nav-item active" data-ss="overview" onclick="switchSSTab(this,'overview')">Overview</div>
      <div class="ss-nav-item" data-ss="roles" onclick="switchSSTab(this,'roles')">Roles</div>
      <div class="ss-nav-item" data-ss="channels" onclick="switchSSTab(this,'channels')">Channels</div>
      <div class="ss-nav-item" data-ss="permissions" onclick="switchSSTab(this,'permissions')">Permissions</div>
      <div class="ss-nav-item" data-ss="members" onclick="switchSSTab(this,'members')">Members</div>
      <div class="ss-nav-separator"></div>
      <div class="ss-nav-category">Moderation</div>
      <div class="ss-nav-item" data-ss="audit" onclick="switchSSTab(this,'audit')">Audit Log</div>
      <div class="ss-nav-item" data-ss="bans" onclick="switchSSTab(this,'bans')">Bans</div>
      <div class="ss-nav-separator"></div>
      <div class="ss-nav-item danger" onclick="showToast('Server deletion requires confirmation')">Delete Server</div>
    </div>
  </div>
  <div class="ss-content" id="ssContent"></div>
  <button class="ss-close" onclick="closeServerSettings()">âœ•</button>
</div>

<!-- Stream Picker Modal -->
<div class="stream-picker-overlay" id="streamPickerOverlay">
  <div class="stream-picker">
    <div class="stream-picker-header">
      <h2>ğŸ–¥ï¸ Share Your Screen</h2>
      <p>Choose what you'd like to stream to the voice channel.</p>
    </div>
    <div class="stream-picker-tabs">
      <button class="stream-picker-tab active" onclick="switchStreamTab(this, 'screens')">Screens</button>
      <button class="stream-picker-tab" onclick="switchStreamTab(this, 'windows')">Windows</button>
      <button class="stream-picker-tab" onclick="switchStreamTab(this, 'camera')">Camera</button>
    </div>
    <div class="stream-picker-body" id="streamPickerBody">
      <div class="stream-source-card selected" onclick="selectStreamSource(this)">
        <div class="stream-source-preview">ğŸ–¥ï¸</div>
        <div class="stream-source-name">Entire Screen</div>
      </div>
      <div class="stream-source-card" onclick="selectStreamSource(this)">
        <div class="stream-source-preview">ğŸªŸ</div>
        <div class="stream-source-name">Application Window</div>
      </div>
    </div>
    <div class="stream-picker-footer">
      <div class="stream-picker-options">
        <div class="stream-option">
          <span>Quality:</span>
          <select id="streamQualitySelect">
            <option value="720p">720p</option>
            <option value="1080p" selected>1080p</option>
            <option value="source">Source</option>
          </select>
        </div>
        <div class="stream-option">
          <span>FPS:</span>
          <select id="streamFpsSelect">
            <option value="15">15</option>
            <option value="30" selected>30</option>
            <option value="60">60</option>
          </select>
        </div>
        <div class="stream-option">
          <label style="display:flex;align-items:center;gap:4px;cursor:pointer;">
            <input type="checkbox" id="streamAudioCheck" checked style="accent-color:var(--nexus-primary);">
            Audio
          </label>
        </div>
      </div>
      <div class="stream-picker-actions">
        <button class="btn btn-secondary" onclick="closeStreamPicker()">Cancel</button>
        <button class="btn btn-primary" onclick="startScreenStream()">Go Live</button>
      </div>
    </div>
  </div>
</div>

<!-- PiP Mini Player -->
<div class="pip-player" id="pipPlayer">
  <video id="pipVideo" autoplay muted></video>
  <div class="pip-player-bar">
    <span class="pip-player-name" id="pipName">NexusUser's stream</span>
    <button class="pip-player-btn" onclick="expandStream()" title="Expand">ğŸ”²</button>
    <button class="pip-player-btn" onclick="closePip()" title="Close">âœ•</button>
  </div>
</div>

<!-- ============ MAIN APP ============ -->
<div class="app-container">

  <!-- Server Navigation -->
  <nav class="server-nav" id="serverNav">
    <div class="server-icon home-btn active" data-tooltip="Direct Messages" data-server="home" onclick="switchServer('home')">
      <svg width="26" height="26" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12c0 1.82.49 3.53 1.34 5L2 22l5-1.34C8.47 21.51 10.18 22 12 22c5.52 0 10-4.48 10-10S17.52 2 12 2zm-2 13l-3-3 1.41-1.41L10 12.17l5.59-5.59L17 8l-7 7z"/></svg>
    </div>
    <div class="server-separator"></div>
    <!-- Dynamic servers inserted here by renderServerList() -->
    <div class="server-separator"></div>
    <div class="server-icon add-server" data-tooltip="Create a Space" onclick="openServerWizard()">+</div>
    <div class="server-separator"></div>
    <div class="server-icon discover-btn" data-tooltip="Explore Public Spaces">ğŸ§­</div>
  </nav>

  <!-- Channel Sidebar -->
  <aside class="channel-sidebar" id="channelSidebar">
    <div class="sidebar-header" onclick="toggleServerDropdown()">
      <h2 id="sidebarTitle">Nexus HQ</h2>
      <span class="dropdown-icon">â–¼</span>
    </div>

    <div class="channel-list" id="channelList">
      <!-- Populated by JS -->
    </div>

    <!-- Voice Connected Bar -->
    <div class="voice-connected-bar" id="voiceBar">
      <div class="voice-connected-info">
        <span class="voice-connected-status">ğŸ”Š Voice Connected</span>
        <span class="voice-connected-channel" id="voiceChannelName">General Voice</span>
      </div>
      <div class="voice-controls">
        <button class="go-live-btn" id="goLiveBtn" onclick="openStreamPicker()" title="Share your screen">ğŸ–¥ï¸ Go Live</button>
        <button class="voice-control-btn" onclick="openModal('watchPartyModal')" title="Watch Party" style="font-size:14px;">ğŸ¬</button>
        <button class="voice-control-btn" id="vcMute" onclick="toggleVoiceMute()" title="Mute">ğŸ¤</button>
        <button class="voice-control-btn" id="vcDeafen" onclick="toggleVoiceDeafen()" title="Deafen">ğŸ§</button>
        <button class="voice-control-btn disconnect" onclick="disconnectVoice()" title="Disconnect">ğŸ“</button>
      </div>
    </div>

    <!-- User Panel -->
    <div class="user-panel">
      <div class="user-panel-avatar" onclick="showUserPopup(currentUser, event)">
        N
        <div class="status-dot online"></div>
      </div>
      <div class="user-panel-info" onclick="showUserPopup(currentUser, event)">
        <div class="user-panel-name">NexusUser</div>
        <div class="user-panel-tag">Online</div>
      </div>
      <div class="user-panel-controls">
        <button class="user-control-btn" id="micBtn" onclick="toggleMic()" title="Mute">ğŸ¤</button>
        <button class="user-control-btn" id="deafenBtn" onclick="toggleDeafen()" title="Deafen">ğŸ§</button>
        <button class="user-control-btn" onclick="openSettings()" title="Settings">âš™ï¸</button>
      </div>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Chat Header -->
    <header class="chat-header">
      <span class="chat-header-icon" id="chatHeaderIcon">#</span>
      <span class="chat-header-name" id="chatHeaderName">general</span>
      <div class="header-divider"></div>
      <span class="chat-header-topic" id="chatHeaderTopic">Welcome to the general channel â€” say hi!</span>
      <div class="header-actions">
        <button class="header-action-btn" onclick="togglePinned()" title="Pinned Messages">ğŸ“Œ</button>
        <button class="header-action-btn" id="membersToggleBtn" onclick="toggleMembers()" title="Member List">ğŸ‘¥</button>
        <div class="header-search">
          <span class="header-search-icon">ğŸ”</span>
          <input type="text" placeholder="Search" id="searchInput" onkeydown="handleSearch(event)">
        </div>
        <button class="header-action-btn" title="Inbox">ğŸ“¥</button>
        <button class="header-action-btn" title="Help">â“</button>
      </div>
    </header>

    <!-- Chat Content -->
    <div class="chat-content-wrapper">
      <!-- Stream Viewer -->
      <div class="stream-container" id="streamContainer">
        <div class="stream-header-bar">
          <div class="stream-live-dot"></div>
          <div class="stream-info">
            <div class="stream-info-name" id="streamInfoName">NexusUser</div>
            <div class="stream-info-detail" id="streamInfoDetail">Screen â€” 1080p 30fps</div>
          </div>
          <div class="stream-viewer-count">ğŸ‘ï¸ <span id="streamViewerCount">0</span></div>
          <button class="stream-close-btn" onclick="minimizeStream()" title="Minimize to PiP">ğŸ”½</button>
          <button class="stream-close-btn" onclick="stopScreenStream()" title="Close">âœ•</button>
        </div>
        <div class="stream-video-area">
          <video id="streamVideo" autoplay></video>
          <div class="stream-video-placeholder" id="streamPlaceholder" style="display:none;">
            <div class="icon">ğŸ–¥ï¸</div>
            <p>Stream starting...</p>
          </div>
        </div>
        <div class="stream-controls-bar">
          <button class="stream-ctrl-btn" id="streamMuteBtn" onclick="toggleStreamMute()" title="Mute">ğŸ¤</button>
          <button class="stream-ctrl-btn" onclick="toggleStreamAudio()" title="Stream Audio">ğŸ”Š</button>
          <select class="stream-quality-selector" id="streamQualityLive" onchange="changeStreamQuality(this.value)">
            <option value="720p">720p</option>
            <option value="1080p" selected>1080p</option>
            <option value="source">Source</option>
          </select>
          <input type="range" class="stream-volume-slider" min="0" max="100" value="100" title="Volume">
          <div class="stream-controls-spacer"></div>
          <button class="stream-ctrl-btn end-stream" onclick="stopScreenStream()" title="End Stream">End Stream</button>
          <button class="stream-fullscreen-btn" onclick="toggleStreamFullscreen()" title="Fullscreen">â›¶</button>
        </div>
      </div>

      <!-- Watch Party Viewer -->
      <div class="watch-party-container" id="watchPartyContainer">
        <div class="wp-header">
          <span class="wp-badge">Watch Party</span>
          <span class="wp-title" id="wpTitle">Watch Party</span>
          <div class="wp-viewer-count">ğŸ‘ï¸ <span id="wpViewerCount">0</span> watching</div>
          <div class="wp-actions">
            <button class="wp-action-btn wp-invite-btn" onclick="showToast('Invite link copied!')">ğŸ“ Invite</button>
            <button class="wp-action-btn wp-leave-btn" onclick="leaveWatchParty()">Leave</button>
          </div>
        </div>
        <div class="wp-screen-area">
          <div class="wp-video-area">
            <div class="wp-mock-video" id="wpVideo">
              <div class="wp-bg" id="wpBg">ğŸ“º</div>
              <div class="wp-mock-content">
                <div class="wp-icon" id="wpIcon">ğŸ¿</div>
                <div class="wp-label" id="wpLabel">Watch Party</div>
                <div class="wp-sublabel" id="wpSublabel">Waiting for host to start...</div>
              </div>
            </div>
            <div class="wp-floating-reactions" id="wpFloatingReactions"></div>
            <div class="wp-controls">
              <button class="wp-ctrl-btn" onclick="toggleWPPlayback()" id="wpPlayBtn">â–¶ï¸</button>
              <div class="wp-progress"><div class="wp-progress-fill" id="wpProgressFill"></div></div>
              <span class="wp-time" id="wpTime">0:00 / 0:00</span>
              <button class="wp-ctrl-btn" onclick="toggleStreamFullscreen()">â›¶</button>
            </div>
          </div>
          <div class="wp-sidebar">
            <div class="wp-sidebar-tabs">
              <button class="wp-sidebar-tab active" onclick="switchWPSidebarTab(this,'chat')">ğŸ’¬ Chat</button>
              <button class="wp-sidebar-tab" onclick="switchWPSidebarTab(this,'viewers')">ğŸ‘¥ Viewers</button>
            </div>
            <div class="wp-chat-area" id="wpChatArea"></div>
            <div class="wp-viewer-list" id="wpViewerList" style="display:none;"></div>
            <div class="wp-reaction-bar">
              <button class="wp-reaction-btn" onclick="sendWPReaction('â¤ï¸')">â¤ï¸</button>
              <button class="wp-reaction-btn" onclick="sendWPReaction('ğŸ˜‚')">ğŸ˜‚</button>
              <button class="wp-reaction-btn" onclick="sendWPReaction('ğŸ”¥')">ğŸ”¥</button>
              <button class="wp-reaction-btn" onclick="sendWPReaction('ğŸ˜®')">ğŸ˜®</button>
              <button class="wp-reaction-btn" onclick="sendWPReaction('ğŸ‘')">ğŸ‘</button>
              <button class="wp-reaction-btn" onclick="sendWPReaction('ğŸ’€')">ğŸ’€</button>
              <button class="wp-reaction-btn" onclick="sendWPReaction('ğŸ‰')">ğŸ‰</button>
              <button class="wp-reaction-btn" onclick="sendWPReaction('ğŸ‘€')">ğŸ‘€</button>
            </div>
            <div class="wp-chat-input-area">
              <div class="wp-chat-input-row">
                <input type="text" class="wp-chat-input" id="wpChatInput" placeholder="Chat during the party..." onkeydown="if(event.key==='Enter')sendWPChat()">
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Streamer Hub -->
      <div class="streamer-hub" id="streamerHub">
        <div class="hub-header">
          <span class="hub-header-icon">ğŸ“º</span>
          <div>
            <div class="hub-header-title">Streamer Hub</div>
            <div class="hub-header-subtitle">Watch, stream, and connect with your community</div>
          </div>
          <span class="hub-twitch-badge">Twitch</span>
          <button class="hub-connect-btn connect" id="twitchConnectBtn" onclick="toggleTwitchConnect()">
            <span>ğŸ”—</span> Connect Twitch
          </button>
        </div>
        <div class="hub-tabs">
          <button class="hub-tab active" data-hub-tab="live" onclick="switchHubTab(this,'live')">ğŸ”´ Live Now <span class="tab-count" id="liveCount">0</span></button>
          <button class="hub-tab" data-hub-tab="following" onclick="switchHubTab(this,'following')">ğŸ’œ Following</button>
          <button class="hub-tab" data-hub-tab="alerts" onclick="switchHubTab(this,'alerts')">ğŸ”” Alerts</button>
          <button class="hub-tab" data-hub-tab="dashboard" onclick="switchHubTab(this,'dashboard')">ğŸ“Š Dashboard</button>
        </div>
        <div class="hub-content" id="hubContent">
          <!-- Populated by JS -->
        </div>
      </div>

      <!-- Twitch Stream Viewer -->
      <div class="twitch-viewer" id="twitchViewer">
        <div class="twitch-viewer-header">
          <div class="twitch-viewer-avatar" id="tvAvatar" style="background:#9146FF;">?</div>
          <div class="twitch-viewer-info">
            <div class="twitch-viewer-name" id="tvName">Streamer <span class="partner-badge">âœ“</span></div>
            <div class="twitch-viewer-title" id="tvTitle">Stream title</div>
          </div>
          <div class="twitch-viewer-stats">
            <div class="twitch-stat"><div class="twitch-stat-value" id="tvViewers">0</div><div class="twitch-stat-label">Viewers</div></div>
            <div class="twitch-stat"><div class="twitch-stat-value" id="tvUptime">0m</div><div class="twitch-stat-label">Uptime</div></div>
          </div>
          <div class="twitch-viewer-actions">
            <button class="twitch-action-btn twitch-follow-btn" id="tvFollowBtn" onclick="toggleTwitchFollow()">ğŸ’œ Follow</button>
            <button class="twitch-action-btn twitch-share-btn" onclick="shareTwitchStream()">â†— Share</button>
            <button class="twitch-action-btn twitch-close-btn" onclick="closeTwitchViewer()">âœ• Close</button>
          </div>
        </div>
        <div class="twitch-viewer-screen">
          <div class="twitch-viewer-video">
            <div class="twitch-mock-stream" id="tvStream">
              <div class="stream-bg" id="tvStreamBg">ğŸ®</div>
              <div class="stream-content">
                <div class="stream-game-icon" id="tvGameIcon">ğŸ®</div>
                <div class="stream-game-name" id="tvGameName">Game</div>
                <div class="stream-game-detail" id="tvGameDetail">Loading stream...</div>
              </div>
            </div>
          </div>
          <div class="twitch-chat-panel" id="twitchChatPanel">
            <div class="twitch-chat-header">
              <span class="twitch-chat-header-title">Stream Chat</span>
              <button class="twitch-chat-toggle active" id="chatSyncToggle" onclick="toggleChatSync()">Sync</button>
            </div>
            <div class="twitch-chat-messages" id="twitchChatMessages"></div>
            <div class="twitch-chat-input-area">
              <div class="twitch-chat-input-wrapper">
                <input type="text" class="twitch-chat-input" id="twitchChatInput" placeholder="Send a message" onkeydown="if(event.key==='Enter')sendTwitchChat()">
                <button class="twitch-chat-send" onclick="sendTwitchChat()">â¤</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Alert Popup Container -->
      <div id="alertPopupContainer"></div>

      <!-- Messages Area -->
      <div class="messages-area" id="messagesAreaWrapper">
        <div class="messages-scroller" id="messagesScroller">
          <div class="spacer"></div>
          <!-- Channel Welcome -->
          <div class="channel-welcome" id="channelWelcome">
            <div class="channel-welcome-icon">#</div>
            <h1>Welcome to #general</h1>
            <p>This is the start of the #general channel. Use this channel for general conversation with your community.</p>
          </div>
          <!-- Messages populated by JS -->
          <div id="messagesContainer"></div>
        </div>
        <!-- Typing Indicator -->
        <div class="typing-indicator" id="typingIndicator" style="visibility:hidden;">
          <div class="typing-dots"><span></span><span></span><span></span></div>
          <span id="typingText">Someone is typing...</span>
        </div>
        <!-- Input Area -->
        <div class="input-area">
          <div class="input-wrapper" id="inputWrapper">
            <div class="input-top-bar" id="replyBar">
              <span>Replying to <strong id="replyTarget"></strong></span>
              <span class="reply-close" onclick="cancelReply()">âœ•</span>
            </div>
            <div class="input-main">
              <button class="input-btn" onclick="document.getElementById('fileUpload').click()" title="Upload File">â•</button>
              <input type="file" id="fileUpload" style="display:none" onchange="handleFileUpload(event)">
              <textarea class="input-field" id="messageInput" placeholder="Message #general" rows="1" onkeydown="handleInputKeydown(event)" oninput="autoResize(this)"></textarea>
              <button class="input-btn" onclick="toggleMediaPicker()" title="GIF & Stickers">ğŸ</button>
              <button class="input-btn" onclick="toggleEmojiPicker()" title="Emoji" style="position:relative;">
                ğŸ˜Š
                <div class="emoji-picker" id="emojiPicker">
                  <div class="emoji-picker-search">
                    <input type="text" placeholder="Search emoji..." id="emojiSearch" oninput="filterEmojis(this.value)">
                  </div>
                  <div class="emoji-grid" id="emojiGrid"></div>
                </div>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Pinned Messages Panel -->
      <div class="pinned-panel" id="pinnedPanel">
        <div class="pinned-panel-header">ğŸ“Œ Pinned Messages</div>
        <div id="pinnedMessages">
          <div class="pinned-message">
            <div style="display:flex;gap:8px;align-items:flex-start;">
              <div style="width:24px;height:24px;border-radius:50%;background:var(--nexus-primary);display:flex;align-items:center;justify-content:center;font-size:10px;color:#fff;font-weight:700;flex-shrink:0;">A</div>
              <div>
                <div style="font-size:12px;font-weight:600;color:var(--nexus-primary-hover);">Admin</div>
                <div style="font-size:13px;color:var(--text-primary);margin-top:2px;">Welcome to Nexus HQ! Please read the rules in #rules before posting. Have fun! ğŸ‰</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Members Sidebar -->
      <aside class="members-sidebar" id="membersSidebar">
        <div id="membersList">
          <!-- Populated by JS -->
        </div>
      </aside>
    </div>
  </main>
</div>

<script src="/socket.io/socket.io.js"></script>
<script src="api-client.js"></script>
<script src="voice-engine.js"></script>
<script src="backend-bridge.js"></script>
<script src="auth.js"></script>
<script src="nexus-sdk.js"></script>
<script src="twitch-integration.js"></script>
<script src="server-management.js"></script>
<script src="watch-party.js"></script>
<script src="app.js"></script>
<script src="calls.js"></script>
<script src="social.js"></script>
<script src="themes.js"></script>
</body>
</html>